{{- $ext := default (dict "enabled" false "name" "") .Values.externalJwtSecret -}}
{{- if not $ext.enabled -}}
{{- include "docker-homework-app.validate" . -}}
{{- $name := printf "%s-jwt-secret" (include "docker-homework-app.fullname" .) -}}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $name -}}
{{- $jwt := "" -}}
{{- if .Values.jwt.secret -}}
  {{- $jwt = .Values.jwt.secret -}}
{{- else if $existing -}}
  {{- $jwt = index $existing.data "Jwt__Secret" | b64dec -}}
{{- else -}}
  {{- $jwt = randAlphaNum 64 -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $name }}
  labels:
    {{- include "docker-homework-app.labels" . | nindent 4 }}
  annotations:
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
type: Opaque
stringData:
  Jwt__Issuer: {{ .Values.jwt.issuer | quote }}
  Jwt__Audience: {{ .Values.jwt.audience | quote }}
  Jwt__AccessTokenMinutes: {{ .Values.jwt.accessTokenMinutes | quote }}
  Jwt__Secret: {{ $jwt | quote }}
{{- end -}}